<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uma Experiência</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            background-color: black;
        }
        .screen {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out;
            color: white;
            padding: 1rem;
        }
        .hidden {
            display: none;
        }
        .windows-bg {
            background-image: url('https://i.imgur.com/M22HjB2.jpeg');
            background-size: cover;
            background-position: center;
        }
        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-shadow: 2px 2px 4px #000000;
            cursor: pointer;
        }
        .desktop-icon img {
            width: 80px;
            height: 80px;
            margin-bottom: 8px;
        }
        .jumpscare {
            background-image: url('https://i.ytimg.com/vi/g3eH4as63eM/maxresdefault.jpg');
            background-size: cover;
            background-position: center;
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        #bossCanvas {
            background-color: #0d0d0d;
            border: 2px solid #333;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
        .fight-button-container {
            position: absolute;
            bottom: 5%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        .grayscale {
            filter: grayscale(100%);
        }
        .broken-button {
            animation: shake 0.8s infinite;
            background: repeating-linear-gradient(45deg, #606dbc, #606dbc 10px, #465298 10px, #465298 20px);
            color: #ff0000;
            text-shadow: 2px 2px #000;
        }
        .global-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .modal {
            background-color: rgba(0,0,0,0.8);
            z-index: 2000;
        }
        /* Estilo para a notificação customizada */
        #notification-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            border: 2px solid #fff;
            z-index: 9999;
            font-size: 18px;
            transition: opacity 0.5s, top 0.5s;
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-black">

    <audio id="quizMusic" loop>
        <source src="https://ia800504.us.archive.org/12/items/PapersPleaseMusic-GloryToArstotzka/PapersPleaseTheme.mp3" type="audio/mpeg">
    </audio>

    <!-- Notificação customizada (substitui o alert) -->
    <div id="notification-box"></div>

    <!-- UI Global -->
    <div class="global-button-container">
        <button id="luanButton" class="px-4 py-2 bg-red-800 text-white rounded-lg shadow-lg hover:bg-red-700 transition-colors">Eu sou o Luan</button>
        <button id="samukaButton" class="px-4 py-2 bg-yellow-600 text-white rounded-lg shadow-lg hover:bg-yellow-500 transition-colors">Eu sou o Samuka</button>
        <button id="dollyButton" class="px-4 py-2 bg-pink-600 text-white rounded-lg shadow-lg hover:bg-pink-500 transition-colors">Eu sou o Dolly</button>
        <button id="saveButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-500 transition-colors">Salvar Jogo</button>
    </div>
    <div id="loadSaveModal" class="screen modal hidden">
        <div class="bg-gray-800 p-8 rounded-lg text-white shadow-2xl">
            <h2 class="text-2xl mb-6">Carregar o outro save?</h2>
            <div class="flex justify-center gap-4">
                <button id="confirmLoadButton" class="px-8 py-3 bg-green-600 rounded-lg hover:bg-green-500">Sim</button>
                <button id="denyLoadButton" class="px-8 py-3 bg-red-600 rounded-lg hover:bg-red-500">Nao</button>
            </div>
        </div>
    </div>
    <div id="passwordModal" class="screen modal hidden">
        <div class="bg-gray-800 p-8 rounded-lg text-white shadow-2xl">
            <h2 id="passwordModalTitle" class="text-2xl mb-4"></h2>
            <input type="password" id="passwordInput" class="p-2 rounded-lg text-black">
            <button id="passwordSubmit" class="ml-2 px-4 py-2 rounded-lg">Entrar</button>
        </div>
    </div>
    <div id="secretModeScreen" class="screen modal hidden">
         <div id="secretModePanel" class="bg-gray-900 p-8 rounded-lg text-white shadow-2xl border-4 max-w-4xl w-full">
            <h2 id="secretModeTitle" class="text-3xl mb-4"></h2>
            <p id="secretModeSpoilers" class="mb-2 text-left"></p>
            <p id="secretModeExclusive" class="mb-6 text-left text-pink-400"></p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button class="teleport-button px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded" data-boss="smile">Teleporte: :(</button>
                <button class="teleport-button px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded" data-boss="brother">Teleporte: :D</button>
                <button class="teleport-button px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded" data-boss="supremacy">Teleporte: O_O</button>
                <button class="teleport-button px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded" data-boss="frog">Teleporte: Sapo</button>
                <button class="teleport-button px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded" data-boss="colon">Teleporte: ●_●</button>
                <button class="teleport-button px-4 py-2 bg-red-800 hover:bg-red-700 rounded" data-boss="final">Teleporte: :[</button>
            </div>
            <div class="mt-4">
                <input type="text" id="secretCommandInput" placeholder="Digite um comando..." class="p-2 rounded-lg text-black w-2/3">
                <button id="secretCommandSubmit" class="ml-2 px-4 py-2 bg-red-700 rounded-lg hover:bg-red-600">Executar</button>
            </div>
            <button id="secretContinueButton" class="mt-6 px-8 py-3 bg-blue-600 rounded-lg hover:bg-blue-500">Continuar o jogo anterior</button>
        </div>
    </div>
    <div id="crashScreen" class="screen bg-red-900 text-white hidden">
        <h1 class="text-6xl">TRAPAÇA DETETADA.</h1>
    </div>

    <!-- Telas do Caminho 1 -->
    <div id="startScreen" class="screen bg-gray-200">
        <button id="startButton" class="px-12 py-6 bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 text-white font-bold rounded-lg shadow-xl transform hover:scale-110 transition-transform">Clique em Mim</button>
    </div>
    <div id="smileScreen" class="screen bg-black hidden"><h1 id="smileFace" class="text-9xl mb-8">:)</h1><p id="smileText" class="text-2xl"></p><button id="whiteButton" class="mt-8 px-8 py-4 bg-white text-black font-bold rounded-lg shadow-lg hidden">...</button></div>
    <div id="windowsScreen" class="screen windows-bg justify-start items-start p-8 hidden"><div id="gameIcon" class="desktop-icon"><img src="https://www.windows7.com.br/imagens/icones/Windows-Media-Center.png" alt="Ícone de Jogo"><span>Quiz do Windows</span></div></div>
    <div id="quizScreen" class="screen bg-blue-900 hidden"><div class="bg-black bg-opacity-50 p-8 rounded-lg shadow-2xl max-w-2xl w-full"><h2 class="text-3xl mb-6" style="font-family: 'VT323', monospace;">Quiz do Windows!1!1</h2><p id="questionText" class="text-xl mb-8"></p><div id="answersContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div></div>
    <div id="postQuizSmileScreen" class="screen bg-black hidden"><h1 class="text-9xl mb-8">;)</h1><p class="text-2xl">Parabens! Vc completou o quiz!</p><p class="text-2xl">Agora clique nesse botao abaixo.</p><button id="toEndButton" class="mt-8 px-8 py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold rounded-lg shadow-lg">Finalizar</button></div>
    <div id="endScreen" class="screen bg-gray-800 hidden"><h1 class="text-8xl">FIM.</h1><p id="endMessage" class="mt-8 text-xl text-yellow-300"></p></div>
    <div id="angryScreen" class="screen bg-gradient-to-br from-red-500 to-orange-400 hidden"><h2 class="text-4xl p-4">Muito bem... Vc quer me irritar certo...</h2></div>
    <div id="jumpscareScreen" class="screen jumpscare hidden"></div>
    <div id="connectionLostScreen" class="screen bg-black text-red-600 hidden"><h1 class="text-6xl">Conexão Perdida.</h1></div>
    <div id="handScreen" class="screen bg-white text-black hidden"><h1 id="hand" class="text-9xl cursor-pointer transform hover:scale-125 transition-transform">👋</h1></div>
    <div id="secondQuizScreen" class="screen bg-gray-900 hidden"><div class="bg-black bg-opacity-75 p-8 rounded-lg shadow-2xl max-w-3xl w-full"><p class="text-red-500 text-2xl mb-6">Vc me irritou... Agora vc vai ter o pior quiz da sua vida...</p><p id="secondQuestionText" class="text-xl mb-8"></p><div id="secondAnswersContainer" class="grid grid-cols-1 gap-4"></div></div></div>
    
    <!-- Telas do Caminho 2 (Irmão) -->
    <div id="bwIntroScreen" class="screen bg-black grayscale hidden"><h1 id="bwFace" class="text-9xl mb-8"></h1><p id="bwIntroText" class="text-2xl p-4"></p><button id="dialogueButton" class="hidden mt-8 px-8 py-4 bg-gray-300 text-black font-bold rounded-lg shadow-lg">Mande a resposta</button></div>
    <div id="chemQuizScreen" class="screen bg-black text-white p-4 grayscale hidden"><div class="bg-white bg-opacity-10 p-8 rounded-lg shadow-2xl max-w-4xl w-full"><h2 class="text-3xl mb-6 text-red-400" style="font-family: 'VT323', monospace;">Quiz da Vingança</h2><p id="chemQuestionText" class="text-lg mb-8"></p><div id="chemAnswersContainer" class="grid grid-cols-1 gap-4"></div></div></div>
    
    <!-- Telas do Caminho 3 (Nova Jornada / Arco de Treino) -->
    <div id="narratorScreen" class="screen bg-black hidden"><p id="narratorText" class="text-2xl p-4"></p></div>
    <div id="newStartScreen" class="screen bg-white hidden"><button id="newStartButton" class="px-12 py-6 bg-gradient-to-r from-violet-500 to-purple-500 text-white font-bold rounded-lg shadow-xl transform hover:scale-110 transition-transform">Clique aqui!!!</button></div>
    <div id="newSmileScreen" class="screen bg-white text-black hidden"><h1 id="newSmileFace" class="text-9xl mb-8"></h1><p id="newSmileText" class="text-2xl"></p><button id="newContinueButton" class="mt-8 px-8 py-4 bg-gray-800 text-white font-bold rounded-lg shadow-lg">Continuar</button></div>
    <div id="foodQuizScreen" class="screen bg-gray-200 text-black hidden"><div class="bg-white p-8 rounded-lg shadow-2xl max-w-2xl w-full"><h2 class="text-3xl mb-6" style="font-family: 'VT323', monospace;">Quiz de Comidas</h2><p id="foodQuizQuestionText" class="text-xl mb-8"></p><div id="foodQuizAnswersContainer" class="grid grid-cols-1 gap-4"></div></div></div>
    <div id="vegQuizScreen" class="screen bg-gray-200 text-black hidden"><div class="bg-white p-8 rounded-lg shadow-2xl max-w-2xl w-full"><h2 class="text-3xl mb-6" style="font-family: 'VT323', monospace;">Quiz de Vegetais</h2><p id="vegQuizQuestionText" class="text-xl mb-8"></p><div id="vegQuizAnswersContainer" class="grid grid-cols-1 gap-4"></div></div></div>
    <div id="xpGainScreen" class="screen bg-black text-yellow-300 hidden"><h1 id="xpText" class="text-5xl"></h1></div>
    <div id="newEndScreen" class="screen bg-gray-800 hidden"><h1 class="text-8xl">FIM?</h1><p id="newEndMessage" class="mt-8 text-xl text-yellow-300"></p></div>
    
    <!-- Telas do Caminho 4 (Treino da Alma) -->
    <div id="subsoloScreen" class="screen bg-black hidden"><button id="helpButton" class="px-12 py-6 bg-gray-700 text-white font-bold rounded-lg shadow-xl">Procure por ajuda</button><p id="subsoloText" class="mt-8 text-xl"></p></div>
    <div id="soulScreen" class="screen bg-white text-black hidden"><h1 id="soulHeart" class="text-9xl mb-8 text-cyan-400 cursor-pointer">💙</h1><p id="soulText" class="text-2xl"></p></div>

    <!-- Telas de Batalha e Finais Genéricas -->
    <div id="bossFightScreen" class="screen bg-black hidden"><p id="bossIntroText" class="text-2xl mb-4"></p><canvas id="bossCanvas"></canvas><div id="playerActions" class="fight-button-container"><button id="fightButton" class="px-8 py-4 bg-yellow-400 text-black font-bold rounded-full shadow-xl transform hover:scale-110 transition-transform">Lutar</button><button id="healButton" class="px-8 py-4 bg-green-500 text-white font-bold rounded-full shadow-xl transform hover:scale-110 transition-transform">Curar (<span id="healChargesText">3</span>)</button><button id="transformButton" class="px-8 py-4 bg-red-600 text-white font-bold rounded-full shadow-xl transform hover:scale-110 transition-transform">Transforma</button><button id="callAllyButton" class="px-8 py-4 bg-cyan-500 text-white font-bold rounded-full shadow-xl transform hover:scale-110 transition-transform hidden">Chamar O︵O</button></div></div>
    <div id="victoryScreen" class="screen bg-black text-yellow-300 hidden"><h1 id="crown" class="text-9xl cursor-pointer transform hover:rotate-12 transition-transform">👑</h1><p class="mt-4 text-2xl">Você venceu.</p></div>
    <div id="gameOverScreen" class="screen bg-black text-red-500 p-4 hidden"><h1 class="text-8xl">Game Over</h1><p id="gameOverMessage" class="mt-8 text-2xl"></p><button id="retryButton" class="mt-8 px-8 py-4 bg-white text-black font-bold rounded-lg">Tentar Novamente</button></div>
    <div id="hackerEndingScreen" class="screen bg-black text-lime-400 hidden"><h1 class="text-4xl">SYSTEM COMPROMISED.</h1><p class="mt-4 text-2xl">YOU ARE IN CONTROL NOW.</p></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Elementos do DOM ---
        const screens = {};
        document.querySelectorAll('.screen').forEach(s => screens[s.id] = s);
        const audio = { quiz: document.getElementById('quizMusic') };
        const buttons = {
            start: document.getElementById('startButton'),
            white: document.getElementById('whiteButton'),
            toEnd: document.getElementById('toEndButton'),
            fight: document.getElementById('fightButton'),
            retry: document.getElementById('retryButton'),
            dialogue: document.getElementById('dialogueButton'),
            heal: document.getElementById('healButton'),
            transform: document.getElementById('transformButton'),
            newStart: document.getElementById('newStartButton'),
            newContinue: document.getElementById('newContinueButton'),
            save: document.getElementById('saveButton'),
            confirmLoad: document.getElementById('confirmLoadButton'),
            denyLoad: document.getElementById('denyLoadButton'),
            samuka: document.getElementById('samukaButton'),
            dolly: document.getElementById('dollyButton'),
            luan: document.getElementById('luanButton'),
            passwordSubmit: document.getElementById('passwordSubmit'),
            secretContinue: document.getElementById('secretContinueButton'),
            secretCommandSubmit: document.getElementById('secretCommandSubmit'),
            help: document.getElementById('helpButton'),
            callAlly: document.getElementById('callAllyButton'),
        };
        const elements = {
            notificationBox: document.getElementById('notification-box'),
            smileText: document.getElementById('smileText'),
            gameIcon: document.getElementById('gameIcon'),
            endMessage: document.getElementById('endMessage'),
            hand: document.getElementById('hand'),
            crown: document.getElementById('crown'),
            bossIntroText: document.getElementById('bossIntroText'),
            bwFace: document.getElementById('bwFace'),
            bwIntroText: document.getElementById('bwIntroText'),
            healChargesText: document.getElementById('healChargesText'),
            narratorText: document.getElementById('narratorText'),
            newSmileText: document.getElementById('newSmileText'),
            newSmileFace: document.getElementById('newSmileFace'),
            xpText: document.getElementById('xpText'),
            newEndMessage: document.getElementById('newEndMessage'),
            gameOverMessage: document.getElementById('gameOverMessage'),
            passwordInput: document.getElementById('passwordInput'),
            passwordModalTitle: document.getElementById('passwordModalTitle'),
            secretCommandInput: document.getElementById('secretCommandInput'),
            secretModeTitle: document.getElementById('secretModeTitle'),
            secretModePanel: document.getElementById('secretModePanel'),
            secretModeSpoilers: document.getElementById('secretModeSpoilers'),
            secretModeExclusive: document.getElementById('secretModeExclusive'),
            subsoloText: document.getElementById('subsoloText'),
            soulText: document.getElementById('soulText'),
            soulHeart: document.getElementById('soulHeart'),
        };

        // --- Variáveis de Estado do Jogo ---
        let timers = [];
        let currentQuiz1Index = 0, currentQuiz2Index = 0, currentChemQuizIndex = 0, currentSelfQuizIndex = 0, currentFoodQuizIndex = 0, currentVegQuizIndex = 0;
        let lastBossDefeated = null;
        let currentStoryPoint = 'start';
        let samukaModeActive = false;
        let dollyModeActive = false;
        let luanModeActive = false;
        let secretAttackBoost = 1;
        let secretHealthBoost = 0;
        let gameState = {};
        let isGameOver = false;
        let currentPasswordCheck = '';
        let hackerSequence = [];
        const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
        
        // --- Variáveis da Batalha ---
        const canvas = document.getElementById('bossCanvas');
        const ctx = canvas.getContext('2d');
        let playerHealth, maxPlayerHealth, bossHealth, maxBossHealth, bossPhase, healCharges, playerAttackModifier, playerDefense;
        let currentTurn;
        let player, projectiles, gameLoopId;
        
        // --- Dados dos Quizzes ---
        const quiz1Data = [ { question: "Quem que fez esse quiz?", answers: ["Dolly", "Luan", "Ian", "Emanuel"], correct: "Luan" }, { question: "Qual e o nome do roblox do criador desse quiz?", answers: ["SamucaBR", "DollyBR", "Knizy", "IanGamer"], correct: "Knizy" }, { question: "Qual sao os amigos dele?", answers: ["Maria, João, Pedro", "Ana, Bia, Carla", "Samuca, Dolly, Ian e Emanuel", "Lucas, Tiago, Mateus"], correct: "Samuca, Dolly, Ian e Emanuel" } ];
        const quiz2Data = [ { question: "Qual foi a primeira pessoa que o dolly gostou", answers: ["Maria", "Ana", "Alice ou baby alice ou lice", "Carla"], correct: "Alice ou baby alice ou lice" }, { question: "Qual e o maior medo do samuca?", answers: ["Baratas", "Altura", "Undyne imortal ou Doki Doki", "Escuro"], correct: "Undyne imortal ou Doki Doki" }, { question: "Qual%#@%^%^#5168321563156783156723", isGlitched: true } ];
        const chemQuizData = [ { question: "Se 50,0 g de benzeno (C₆H₆) a 25 °C absorvem 2,71 kJ de calor, qual será a temperatura final? (c = 1,72 J/g·°C)", answers: ["42,1 °C", "aproximadamente 56,5 °C", "31,5 °C", "81,5 °C"], correct: "aproximadamente 56,5 °C" }, { question: "Em um ensaio de espectroscopia de absorção atômica, como se calcula a concentração de um elemento em ppb a partir de dados instrumentais?", answers: ["Pela curva de calibração usando padrões", "Resposta simples: converte diretamente a absorbância em concentração (µg/L = ppb)", "Usando a Lei de Beer-Lambert sem calibração", "Medindo a emissão em vez da absorção"], correct: "Resposta simples: converte diretamente a absorbância em concentração (µg/L = ppb)" }, { question: "Qual o número de coordenação de um íon central em um complexo octaédrico e que geometria ele apresenta?", answers: ["Coordenação 4, tetraédrica", "Coordenação 8, cúbica", "octaédrica.", "Coordenação 6, planar quadrada"], correct: "octaédrica." }, { question: "Por que é um desafio construir uma bateria de lítio-ar (Li–O₂) prática? Identifique um dos principais obstáculos.", answers: ["A reatividade do eletrólito com o metal de lítio.", "A formação de peróxidos/superóxidos que degradam os componentes.", "A baixa densidade de energia.", "(Esse eu nao sei)"], correct: "(Esse eu nao sei)" } ];
        const selfQuizData = [ { question: "Qual foi o boss que vc enfrentou agora pouco?", answers: ["O_O", ":D", ":)", "Sapo"], correct: "O_O" }, { question: "Qual era habilidade dele?", answers: ["Bolas brancas", "Sorrisos e Bombas", "Elementos quimicos e raios", "Água"], correct: "Elementos quimicos e raios" }, { question: "Oque ele era antes de ser O_O", answers: [":(", ":]", "D", ":D"], correct: ":D" } ];
        const foodQuizData = [ { question: "Qual destes é uma fruta?", answers: ["Batata", "Maçã", "Cenoura", "Alface"], correct: "Maçã" }, { question: "Qual é o principal ingrediente da pizza Margherita?", answers: ["Ananás", "Frango", "Tomate", "Chocolate"], correct: "Tomate" } ];
        const vegQuizData = [ { question: "Qual destes é um vegetal de raiz?", answers: ["Tomate", "Pepino", "Cenoura", "Pimento"], correct: "Cenoura" }, { question: "Qual vegetal é famoso por fazer chorar ao cortá-lo?", answers: ["Abóbora", "Cebola", "Brócolos", "Espinafre"], correct: "Cebola" } ];
        const chemicalElements = ['H', 'He', 'Li', 'Be', 'B', 'C', 'N', 'O', 'F', 'Ne', 'Na', 'Mg', 'Al', 'Si', 'P', 'S', 'Cl', 'Ar'];

        // --- Função de Notificação (Substitui alert) ---
        function showNotification(message) {
            const box = elements.notificationBox;
            box.textContent = message;
            box.style.top = '20px';
            box.style.opacity = '1';
            setTimeout(() => {
                box.style.top = '-100px';
                box.style.opacity = '0';
            }, 3000);
        }

        // --- Funções de Áudio Seguras ---
        async function playAudio(audioElement) { try { audioElement.currentTime = 0; await audioElement.play(); } catch (error) { if (error.name !== 'AbortError') { console.error('Audio playback error:', error); } } }
        function pauseAudio(audioElement) { if (!audioElement.paused) { audioElement.pause(); } }

        // --- Lógica de Jogo Principal e Save/Load ---
        function getGameState() {
            const savedStateJSON = localStorage.getItem('gameState');
            if (savedStateJSON) {
                return JSON.parse(savedStateJSON);
            }
            return {
                storyPoint: 'start',
                smileWins: 0,
                brotherWins: 0,
                supremacyWins: 0,
                finalWins: 0,
                arc2Unlocked: false,
            };
        }

        function saveGame() {
            gameState.storyPoint = currentStoryPoint;
            localStorage.setItem('gameState', JSON.stringify(gameState));
            showNotification('Jogo Salvo!');
        }

        function loadGame() {
            gameState = getGameState();
            resumeFromState(gameState.storyPoint);
        }
        
        function resumeFromState(storyPoint) {
            currentStoryPoint = storyPoint;
            switch(storyPoint) {
                case 'start': initializeGame(true); break;
                case 'beforeSmileBoss': showScreen('secondQuizScreen'); playAudio(audio.quiz); currentQuiz2Index = 0; loadQuiz2Question(); break;
                case 'beforeBrotherBoss': startBrotherPath(); break;
                case 'beforeSupremacyBoss': startSupremacyPath(); break;
                case 'trainingArc': startSubsoloPath(); break;
                case 'newJourney': startNewJourneyPath(); break;
                case 'beforeColonBoss': startColonBossPath(); break;
                case 'subsolo': startSubsoloPath(); break;
                default: initializeGame(true); break;
            }
        }
        
        function clearAllProgress() {
            localStorage.removeItem('gameState');
            samukaModeActive = false;
            dollyModeActive = false;
            luanModeActive = false;
            secretAttackBoost = 1;
            secretHealthBoost = 0;
            gameState = getGameState();
        }

        function resetGame() {
            clearAllTimers();
            pauseAudio(audio.quiz);
            currentQuiz1Index = 0; currentQuiz2Index = 0; currentChemQuizIndex = 0; currentSelfQuizIndex = 0; currentFoodQuizIndex = 0; currentVegQuizIndex = 0;
        }

        function initializeGame(skipLoadCheck = false) {
            resetGame();
            gameState = getGameState();
            if (gameState.storyPoint !== 'start' && !skipLoadCheck) {
                showScreen('loadSaveModal');
                return;
            }
            
            buttons.start.classList.remove('broken-button');
            if (gameState.arc2Unlocked) {
                buttons.start.textContent = "Clique aqui!!!";
                buttons.start.onclick = startNewJourneyPath;
            } else if (gameState.finalWins > 0) {
                 buttons.start.textContent = "Treinar Alma";
                 buttons.start.onclick = startSubsoloPath;
            } else if (gameState.supremacyWins >= 1) {
                buttons.start.textContent = "??????????";
                buttons.start.classList.add('broken-button');
                buttons.start.onclick = startSupremacyPath;
            } else if (gameState.brotherWins >= 3) {
                buttons.start.textContent = "C̴l̴i̴q̴u̴e̴ ̴e̴m̴ ̴M̴i̴m̴";
                buttons.start.classList.add('broken-button');
                buttons.start.onclick = startBrotherPath;
            } else {
                buttons.start.textContent = "Clique em Mim";
                buttons.start.onclick = startNormalPath;
            }
            showScreen('startScreen');
        }

        function startNormalPath() { currentStoryPoint = 'start'; showScreen('smileScreen'); elements.smileText.textContent = ''; buttons.white.classList.add('hidden'); timers.push(setTimeout(() => { elements.smileText.textContent = "clique no botão branco abaixo"; buttons.white.classList.remove('hidden'); }, 7000)); }
        function startBrotherPath() { currentStoryPoint = 'beforeBrotherBoss'; showScreen('bwIntroScreen'); elements.bwFace.textContent = ":D"; elements.bwIntroText.textContent = "Oh... Eu vi que vc matou meu irmao 3 vezes..."; timers.push(setTimeout(() => { elements.bwIntroText.textContent = "Eu vi tudo......................."; timers.push(setTimeout(() => { showScreen('chemQuizScreen'); currentChemQuizIndex = 0; loadChemQuizQuestion(); }, 4000)); }, 4000)); }
        function startSupremacyPath() { currentStoryPoint = 'beforeSupremacyBoss'; showScreen('bwIntroScreen'); elements.bwFace.textContent = ":D"; elements.bwIntroText.textContent = "Vc ira pagar,Vc ira pagar,Vc ira pagar..."; timers.push(setTimeout(() => { elements.bwFace.textContent = "O_O"; elements.bwIntroText.textContent = "SE CURVE PARA A SUPREMACIA, O AUGE DO FULKERHENS"; buttons.dialogue.classList.remove('hidden'); }, 5000)); }
        
        function startNewJourneyPath() {
            currentStoryPoint = 'newJourney';
            showScreen('newSmileScreen');
            elements.newSmileFace.textContent = "O︵O";
            elements.newSmileText.textContent = "Relaxa, se vc acha que eu vou tentar te matar, vc esta enganado, eu vou te ajudar, aqui nesse novo mundo, vc mata, ou e morto.... Enfim clique no botão abaixo para iniciar sua jornada nova!!";
            buttons.newContinue.textContent = "Iniciar Jornada";
            buttons.newContinue.classList.remove('hidden');
            buttons.newContinue.onclick = () => {
                showScreen('newSmileScreen');
                elements.newSmileFace.textContent = "●_●";
                elements.newSmileText.textContent = "Vamos logo!!! clique na porcaria do botão abaixo";
                buttons.newContinue.textContent = "Continuar";
                buttons.newContinue.onclick = () => {
                    showScreen('foodQuizScreen');
                    loadFoodQuizQuestion();
                };
            };
        }

        function startSubsoloPath() {
            currentStoryPoint = 'subsolo';
            showScreen('subsoloScreen');
            elements.subsoloText.textContent = '';
            buttons.help.classList.remove('hidden');
            timers.push(setTimeout(() => {
                buttons.help.classList.remove('hidden');
            }, 8000));
        }

        function startSoulTraining() {
            currentStoryPoint = 'trainingArc';
            showScreen('soulScreen');
            elements.soulText.textContent = "aqui e sua alma, treine lutando contra esses sentimentos para ficar com o seu xp maior";
            
            const sentimentos = ['odio', 'tristeza', 'raiva', 'medo', 'ansiedade'];
            let currentFeelingIndex = 0;

            const fightNextFeeling = () => {
                if (currentFeelingIndex < sentimentos.length) {
                    triggerBossFightIntro('feeling_' + sentimentos[currentFeelingIndex]);
                    currentFeelingIndex++;
                } else {
                    winGame = handleWin;
                    gameState.arc2Unlocked = true;
                    saveGame();
                    showNotification("Você se sente... completo. Volte ao início.");
                    timers.push(setTimeout(() => initializeGame(true), 3000));
                }
            }
            
            timers.push(setTimeout(() => {
                winGame = fightNextFeeling;
                fightNextFeeling();
            }, 4000));
        }
        
        function showScreen(screenId) { Object.values(screens).forEach(s => s.classList.add('hidden')); if (screens[screenId]) screens[screenId].classList.remove('hidden'); }
        function clearAllTimers() { timers.forEach(clearTimeout); timers = []; if (gameLoopId) cancelAnimationFrame(gameLoopId); }

        // --- Lógica dos Quizzes ---
        function loadQuiz1Question() { if (currentQuiz1Index >= quiz1Data.length) { showScreen('postQuizSmileScreen'); return; } const q = quiz1Data[currentQuiz1Index]; document.getElementById('questionText').textContent = q.question; const a = document.getElementById('answersContainer'); a.innerHTML = ''; q.answers.forEach(ans => { const b = document.createElement('button'); b.textContent = ans; b.className = "w-full p-4 bg-blue-700 hover:bg-blue-600 rounded-lg transition-colors"; b.onclick = () => handleQuiz1Answer(ans); a.appendChild(b); }); }
        function handleQuiz1Answer(sel) { if (sel === quiz1Data[currentQuiz1Index].correct) { currentQuiz1Index++; loadQuiz1Question(); } else { screens.quizScreen.classList.add('animate-pulse'); setTimeout(() => screens.quizScreen.classList.remove('animate-pulse'), 500); } }
        function loadQuiz2Question() { if (currentQuiz2Index >= quiz2Data.length) return; const q = quiz2Data[currentQuiz2Index]; document.getElementById('secondQuestionText').textContent = q.question; const a = document.getElementById('secondAnswersContainer'); a.innerHTML = ''; if (q.isGlitched) { currentStoryPoint = 'beforeSmileBoss'; const b = document.createElement('button'); b.textContent = q.question; b.className = "w-full p-4 bg-red-800 hover:bg-red-700 rounded-lg font-mono"; b.onclick = () => triggerBossFightIntro('smile'); a.appendChild(b); } else { q.answers.forEach(ans => { const b = document.createElement('button'); b.textContent = ans; b.className = "w-full p-4 bg-gray-700 hover:bg-gray-600 rounded-lg"; b.onclick = () => handleQuiz2Answer(ans); a.appendChild(b); }); } }
        function handleQuiz2Answer(sel) { if (sel === quiz2Data[currentQuiz2Index].correct) { currentQuiz2Index++; loadQuiz2Question(); } else { screens.secondQuizScreen.classList.add('animate-pulse'); setTimeout(() => screens.secondQuizScreen.classList.remove('animate-pulse'), 500); } }
        function loadChemQuizQuestion() { if (currentChemQuizIndex >= chemQuizData.length) { triggerBossFightIntro('brother'); return; } const q = chemQuizData[currentChemQuizIndex]; document.getElementById('chemQuestionText').textContent = q.question; const a = document.getElementById('chemAnswersContainer'); a.innerHTML = ''; q.answers.forEach(ans => { const b = document.createElement('button'); b.textContent = ans; b.className = "w-full p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"; b.onclick = () => handleChemQuizAnswer(ans); a.appendChild(b); }); }
        function handleChemQuizAnswer(sel) { if (sel === chemQuizData[currentChemQuizIndex].correct) { currentChemQuizIndex++; loadChemQuizQuestion(); } else { screens.chemQuizScreen.classList.add('animate-pulse'); setTimeout(() => screens.chemQuizScreen.classList.remove('animate-pulse'), 500); } }
        function loadFoodQuizQuestion() { if (currentFoodQuizIndex >= foodQuizData.length) { showScreen('newSmileScreen'); elements.newSmileFace.textContent = "●_●"; elements.newSmileText.textContent = "Terminou? Agora a segunda parte do quiz."; buttons.newContinue.onclick = () => { showScreen('vegQuizScreen'); loadVegQuizQuestion(); }; return; } const q = foodQuizData[currentFoodQuizIndex]; document.getElementById('foodQuizQuestionText').textContent = q.question; const a = document.getElementById('foodQuizAnswersContainer'); a.innerHTML = ''; q.answers.forEach(ans => { const b = document.createElement('button'); b.textContent = ans; b.className = "w-full p-4 bg-gray-400 hover:bg-gray-500 rounded-lg transition-colors"; b.onclick = () => handleFoodQuizAnswer(ans); a.appendChild(b); }); }
        function handleFoodQuizAnswer(sel) { if (sel === foodQuizData[currentFoodQuizIndex].correct) { currentFoodQuizIndex++; loadFoodQuizQuestion(); } else { screens.foodQuizScreen.classList.add('animate-pulse'); setTimeout(() => screens.foodQuizScreen.classList.remove('animate-pulse'), 500); } }
        function loadVegQuizQuestion() { if (currentVegQuizIndex >= vegQuizData.length) { showScreen('newEndScreen'); elements.newEndMessage.textContent = ""; timers.push(setTimeout(() => { elements.newEndMessage.textContent = "Saquei como vc e... Igual a todos os outros, eu não irei repetir o que os outros inferiores que vc lutou, que ficam bravo por isso, mas eu irei te destruir para vc não pertubar nem um outro..."; timers.push(setTimeout(() => triggerBossFightIntro('colon'), 8000)); }, 4000)); return; } const q = vegQuizData[currentVegQuizIndex]; document.getElementById('vegQuizQuestionText').textContent = q.question; const a = document.getElementById('vegQuizAnswersContainer'); a.innerHTML = ''; q.answers.forEach(ans => { const b = document.createElement('button'); b.textContent = ans; b.className = "w-full p-4 bg-gray-400 hover:bg-gray-500 rounded-lg transition-colors"; b.onclick = () => handleVegQuizAnswer(ans); a.appendChild(b); }); }
        function handleVegQuizAnswer(sel) { if (sel === vegQuizData[currentVegQuizIndex].correct) { currentVegQuizIndex++; loadVegQuizQuestion(); } else { screens.vegQuizScreen.classList.add('animate-pulse'); setTimeout(() => screens.vegQuizScreen.classList.remove('animate-pulse'), 500); } }

        // --- Lógica da Batalha ---
        function setupCanvas() { const sw = window.innerWidth; const sh = window.innerHeight; canvas.width = Math.min(sw * 0.9, 800); canvas.height = Math.min(sh * 0.7, 600); }
        function triggerBossFightIntro(bossType) {
            lastBossDefeated = bossType;
            pauseAudio(audio.quiz);

            if (luanModeActive) {
                showNotification(`Mestre, o inimigo '${bossType}' foi derrotado pela sua presença.`);
                winGame();
                return;
            }

            showScreen('bossFightScreen');
            let introText = "Vamos acabar com isso.";
            if (bossType === 'smile') introText = "PORQUE?!?! VC QUER FICAR TANTO AQUI!";
            if (bossType === 'brother') introText = "Você é persistente... e irritante.";
            if (bossType === 'supremacy') introText = ".............";
            if (bossType === 'frog') introText = "Croac!";
            if (bossType === 'colon') introText = "Por isso que eu irei te exterminar agora...";
            if (bossType === 'final') introText = "Você voltou?";
            if (bossType === 'system') introText = "SECURITY BREACH DETECTED. INITIATING COUNTERMEASURES.";
            
            elements.bossIntroText.textContent = introText;
            canvas.classList.add('hidden');
            document.getElementById('playerActions').classList.add('hidden');
            timers.push(setTimeout(() => startBossFight(bossType), 3000));
        }

        function startBossFight(bossType) {
            setupCanvas();
            isGameOver = false;
            elements.bossIntroText.textContent = '';
            canvas.classList.remove('hidden');
            
            maxPlayerHealth = 100 + secretHealthBoost;
            playerHealth = maxPlayerHealth;
            bossPhase = 1;
            healCharges = 3;
            playerAttackModifier = 1;
            playerDefense = 1;
            
            player = { x: canvas.width / 2, y: canvas.height / 2, radius: 15, paralyzed: false, transformed: false, rooted: false, poisoned: false, shield: false };

            if (gameState.arc2Unlocked) {
                playerAttackModifier = 254 / 30;
                maxPlayerHealth = 142;
                playerHealth = 142;
                playerDefense = 142;
                healCharges = 6;
            }
            
            let bossLifeMultiplier = gameState.arc2Unlocked ? 2.5 : 1;
            if (bossType === 'supremacy') { maxBossHealth = 200 * bossLifeMultiplier; bossHealth = maxBossHealth; }
            else if (bossType === 'brother') { maxBossHealth = 180 * bossLifeMultiplier; bossHealth = maxBossHealth; }
            else if (bossType === 'frog') { maxBossHealth = 150 * bossLifeMultiplier; bossHealth = maxBossHealth; }
            else if (bossType === 'colon') { maxBossHealth = 400 * bossLifeMultiplier; bossHealth = maxBossHealth; }
            else if (bossType.startsWith('feeling_')) { maxBossHealth = 60; bossHealth = maxBossHealth; }
            else if (bossType === 'final') { maxBossHealth = 300 * bossLifeMultiplier; bossHealth = maxBossHealth; }
            else if (bossType === 'system') { maxBossHealth = 500; bossHealth = maxBossHealth; playerHealth = 9999; maxPlayerHealth = 9999; }
            else { maxBossHealth = 90 * bossLifeMultiplier; bossHealth = maxBossHealth; }

            projectiles = [];
            
            canvas.addEventListener('mousemove', movePlayer);
            startPlayerTurn();
        }

        function startPlayerTurn() {
            currentTurn = 'player';
            player.rooted = false;
            
            if(player.poisoned) {
                playerHealth -= 10;
                showNotification("Você sofreu dano de veneno!");
                if (playerHealth <= 0) {
                    loseGame();
                    return;
                }
            }

            const actions = document.getElementById('playerActions');
            actions.classList.remove('hidden');
            buttons.fight.disabled = false;
            buttons.heal.disabled = healCharges <= 0;
            
            const isAwakened = gameState.arc2Unlocked;
            buttons.transform.textContent = isAwakened ? "Despertar" : "Transforma";
            buttons.transform.disabled = player.transformed;
            buttons.transform.classList.toggle('hidden', !isAwakened);
            
            const showCallAlly = isAwakened && (lastBossDefeated === 'colon' || lastBossDefeated === 'frog');
            buttons.callAlly.classList.toggle('hidden', !showCallAlly);

            elements.healChargesText.textContent = healCharges;
            drawBattleState();
        }

        function handlePlayerAttack() {
            if (currentTurn !== 'player') return;
            bossHealth -= (30 * playerAttackModifier) * secretAttackBoost;
            endPlayerTurn();
            if (bossHealth <= 0) { winGame(); } else { startBossTurn(); }
        }

        function handlePlayerHeal() {
            if (currentTurn !== 'player' || healCharges <= 0) return;
            playerHealth = Math.min(playerHealth + 80, maxPlayerHealth);
            healCharges--;
            endPlayerTurn();
            startBossTurn();
        }
        
        function handlePlayerTransform() {
            if (currentTurn !== 'player' || player.transformed) return;
            player.transformed = true;
            if (gameState.arc2Unlocked) {
                maxPlayerHealth += 100;
                playerHealth += 100;
                playerAttackModifier *= 1.5;
            }
            endPlayerTurn();
            startBossTurn();
        }
        
        function handleCallAlly() {
            if (currentTurn !== 'player') return;
            const item = Math.random() > 0.5 ? 'faca' : 'escudo';
            if (item === 'faca') {
                playerAttackModifier *= 1.5;
                showNotification('O︵O te deu uma faca! Seu ataque aumentou neste turno.');
            } else {
                playerDefense *= 1.5;
                showNotification('O︵O te deu um escudo! Sua defesa aumentou neste turno.');
            }
            endPlayerTurn();
            startBossTurn();
        }

        function endPlayerTurn() {
            buttons.fight.disabled = true;
            buttons.heal.disabled = true;
            buttons.transform.disabled = true;
            buttons.callAlly.disabled = true;
        }

        function startBossTurn() {
            currentTurn = 'boss_attack';
            document.getElementById('playerActions').classList.add('hidden');
            projectiles = [];
            
            if ((lastBossDefeated === 'brother' || lastBossDefeated === 'supremacy' || lastBossDefeated === 'colon' || lastBossDefeated === 'final') && bossHealth <= maxBossHealth / 2 && bossPhase === 1) {
                bossPhase = 2;
            }

            let isPhase2 = (bossPhase === 2);
            let attackSpeed = isPhase2 ? 4 : 2;
            let numProjectiles = isPhase2 ? 40 : 25;
            let attackType = 'default';

            if (lastBossDefeated === 'colon') {
                const attacks = ['default', 'knives', 'spirals'];
                attackType = attacks[Math.floor(Math.random() * attacks.length)];
                attackSpeed = isPhase2 ? 7 : 5; 
                numProjectiles = isPhase2 ? 70 : 50;
            }
            else if (lastBossDefeated === 'final' && !gameState.arc2Unlocked) {
                attackType = 'impossible';
                player.rooted = true;
                player.x = canvas.width / 2;
                player.y = canvas.height / 2;
                numProjectiles = 150;
                attackSpeed = 10;
            }
            else if (lastBossDefeated === 'final' && gameState.arc2Unlocked) { attackSpeed = isPhase2 ? 8 : 5; numProjectiles = isPhase2 ? 70 : 50; attackType = Math.random() > 0.3 ? 'final' : 'lightning'; }
            else if (lastBossDefeated === 'supremacy') { attackSpeed = isPhase2 ? 5 : 3; numProjectiles = isPhase2 ? 50 : 30; attackType = Math.random() > 0.5 ? 'lightning' : 'elements'; }
            else if (lastBossDefeated === 'brother') { attackType = 'elements'; }
            else if (lastBossDefeated === 'frog') { attackSpeed = 1.5; numProjectiles = 15; attackType = 'water'; }
            else if (lastBossDefeated.startsWith('feeling_')) { attackSpeed = 2; numProjectiles = 20; attackType = 'feeling'; }
            else if (lastBossDefeated === 'system') { attackSpeed = 6; numProjectiles = 100; attackType = 'glitch'; }

            for (let i = 0; i < numProjectiles; i++) {
                const side = Math.floor(Math.random() * 4);
                let x, y, vx, vy, text = null, type = 'bullet', radius = 8, angle = 0, angleSpeed = 0.05;
                const speed = (Math.random() * 2) + attackSpeed;
                if (side === 0) { x = 0; y = Math.random() * canvas.height; vx = speed; vy = 0; }
                else if (side === 1) { x = canvas.width; y = Math.random() * canvas.height; vx = -speed; vy = 0; }
                else if (side === 2) { y = 0; x = Math.random() * canvas.width; vx = 0; vy = speed; }
                else { y = canvas.height; x = Math.random() * canvas.width; vx = 0; vy = -speed; }
                
                if (attackType === 'elements') { text = chemicalElements[Math.floor(Math.random() * chemicalElements.length)]; type = 'text'; radius = 12; }
                else if (attackType === 'lightning') { type = 'lightning'; }
                else if (attackType === 'water') { type = 'water'; radius = 15; }
                else if (attackType === 'knives') { type = 'knife'; radius = 10; }
                else if (attackType === 'bombs') { type = 'bomb'; radius = 10; }
                else if (attackType === 'spirals') { type = 'spiral'; x = canvas.width / 2; y = canvas.height / 2; radius = 5; angle = (i / numProjectiles) * Math.PI * 4; angleSpeed = 0.05 + (i % 2 === 0 ? 0.02 : -0.02); }
                else if (attackType === 'final') { type = Math.random() > 0.5 ? 'bomb' : 'smiles'; text = ':['; radius = 12; }
                else if (attackType === 'impossible') { type = 'final'; text = ':['; radius = 15; }
                else if (attackType === 'feeling') { type = 'feeling'; radius = 10; }
                else if (attackType === 'glitch') { type = 'glitch'; radius = Math.random() * 15 + 5; }

                projectiles.push({ x, y, vx, vy, radius, text, type, angle, angleSpeed, initialRadius: radius });
            }
            gameLoopId = requestAnimationFrame(gameLoop);
            timers.push(setTimeout(() => { cancelAnimationFrame(gameLoopId); startPlayerTurn(); }, 5000));
        }
        
        function gameLoop() { updateProjectiles(); checkCollisions(); drawBattleState(); if (currentTurn === 'boss_attack') gameLoopId = requestAnimationFrame(gameLoop); }
        function updateProjectiles() { 
            projectiles.forEach(p => {
                if (p.type === 'knife') {
                    const dx = player.x - p.x;
                    const dy = player.y - p.y;
                    const dist = Math.hypot(dx, dy);
                    if (dist > 1) {
                        p.vx = (dx / dist) * 4;
                        p.vy = (dy / dist) * 4;
                    }
                } else if (p.type === 'spiral') {
                    p.angle += p.angleSpeed;
                    p.radius += 0.5;
                    p.x = canvas.width / 2 + Math.cos(p.angle) * p.radius;
                    p.y = canvas.height / 2 + Math.sin(p.angle) * p.radius;
                    return;
                }
                p.x += p.vx; p.y += p.vy; 
            });
        }
        function checkCollisions() {
            projectiles.forEach(p => {
                const dist = Math.hypot(player.x - p.x, player.y - p.y);
                if (dist < player.radius + p.radius) {
                    if (player.shield) { player.shield = false; p.x = -1000; showNotification('Escudo bloqueou o ataque!'); return; }
                    let damage = 10;
                    if (p.type === 'bomb') damage = 20;
                    if (p.type === 'spiral') { damage = 5; player.poisoned = true; }
                    if (p.type === 'knife') { damage = 15; player.paralyzed = true; setTimeout(() => player.paralyzed = false, 1500); }
                    
                    playerHealth -= damage / playerDefense;
                    p.x = -1000;
                    
                    if (playerHealth <= 0) loseGame();
                }
            });
        }

        function drawBattleState() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBossFace();
            drawHealthBars();

            if (currentTurn === 'boss_attack') {
                ctx.fillStyle = player.paralyzed ? 'gray' : (player.transformed ? 'gold' : 'cyan');
                if (gameState.arc2Unlocked) {
                    ctx.font = "30px 'Press Start 2P'";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText('-_-', player.x, player.y);
                } else {
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
                if (player.paralyzed) { ctx.fillStyle = 'yellow'; ctx.font = "20px 'Press Start 2P'"; ctx.fillText('Zzz', player.x + 25, player.y - 25); }
                if (player.poisoned) { ctx.fillStyle = 'purple'; ctx.font = "20px 'Press Start 2P'"; ctx.fillText('Poison!', player.x + 25, player.y + 25); }
                if (player.shield) { ctx.strokeStyle = 'lightblue'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(player.x, player.y, player.radius + 5, 0, Math.PI * 2); ctx.stroke(); }

                projectiles.forEach(p => {
                    if (p.type === 'text') { ctx.font = "20px 'Press Start 2P'"; ctx.fillStyle = (p.text === ':|' || p.text === ':[') ? 'orange' : 'lime'; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(p.text, p.x, p.y); }
                    else if (p.type === 'lightning') { ctx.fillStyle = 'yellow'; ctx.fillRect(p.x - 2, p.y - 10, 4, 20); }
                    else if (p.type === 'water') { ctx.fillStyle = 'blue'; ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); ctx.fill(); }
                    else if (p.type === 'bomb') { ctx.fillStyle = 'darkred'; ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); ctx.fill(); }
                    else if (p.type === 'spiral') { ctx.fillStyle = 'purple'; ctx.beginPath(); ctx.arc(p.x, p.y, p.initialRadius, 0, Math.PI * 2); ctx.fill(); }
                    else if (p.type === 'feeling') { ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`; ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); ctx.fill(); }
                    else if (p.type === 'knife') { ctx.fillStyle = 'silver'; ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(Math.atan2(p.vy, p.vx)); ctx.fillRect(-15, -2, 30, 4); ctx.restore(); }
                    else if (p.type === 'glitch') { ctx.fillStyle = `rgb(${Math.random()*255},${Math.random()*255},${Math.random()*255})`; ctx.fillRect(p.x, p.y, p.radius, p.radius); }
                    else { ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); ctx.fill(); }
                });
            } else {
                 ctx.font = "40px 'Press Start 2P'"; ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.fillText("Sua vez de atacar!", canvas.width / 2, canvas.height / 2 + 50);
            }
        }

        function drawBossFace() {
            let face = ':(';
            if (lastBossDefeated === 'brother') face = bossPhase === 1 ? ':D' : '>:D';
            else if (lastBossDefeated === 'supremacy') face = 'O_O';
            else if (lastBossDefeated === 'frog') face = '(o.o)';
            else if (lastBossDefeated === 'colon') face = '●_●';
            else if (lastBossDefeated === 'final') face = ':[';
            else if (lastBossDefeated.startsWith('feeling_')) face = '>:|';
            else if (lastBossDefeated === 'system') face = '[x_x]';
            
            ctx.font = "80px 'Press Start 2P'"; ctx.fillStyle = "red"; ctx.textAlign = "center";
            const shakeX = (Math.random() - 0.5) * (1 - (bossHealth / maxBossHealth)) * 15;
            const shakeY = (Math.random() - 0.5) * (1 - (bossHealth / maxBossHealth)) * 15;
            ctx.fillText(face, canvas.width / 2 + shakeX, 120 + shakeY);
        }

        function drawHealthBars() {
            let bossName = 'SORRISO';
            if (lastBossDefeated === 'brother') bossName = 'IRMÃO';
            else if (lastBossDefeated === 'supremacy') bossName = 'SUPREMACIA';
            else if (lastBossDefeated === 'frog') bossName = 'SAPO';
            else if (lastBossDefeated === 'colon') bossName = '●_●';
            else if (lastBossDefeated === 'final') bossName = ':[';
            else if (lastBossDefeated.startsWith('feeling_')) bossName = lastBossDefeated.split('_')[1].toUpperCase();
            else if (lastBossDefeated === 'system') bossName = 'O SISTEMA';

            ctx.fillStyle = '#555'; ctx.fillRect(10, 10, canvas.width - 20, 30);
            let healthColor = 'red';
            if (bossPhase === 2) healthColor = 'purple';
            if (lastBossDefeated === 'supremacy') healthColor = bossPhase === 1 ? 'orange' : '#FF1493';
            ctx.fillStyle = healthColor;
            ctx.fillRect(10, 10, (canvas.width - 20) * (bossHealth / maxBossHealth), 30);
            
            ctx.fillStyle = 'white'; ctx.font = "20px 'Press Start 2P'"; ctx.textAlign = "center"; ctx.fillText(bossName, canvas.width / 2, 35);
            ctx.fillStyle = '#555'; ctx.fillRect(10, canvas.height - 40, canvas.width - 20, 30);
            ctx.fillStyle = player.transformed ? 'gold' : 'cyan';
            ctx.fillRect(10, canvas.height - 40, (canvas.width - 20) * (playerHealth / maxPlayerHealth), 30);
            ctx.fillStyle = 'white'; ctx.fillText(`VOCÊ`, canvas.width / 2, canvas.height - 15);
        }

        function movePlayer(e) { if (player && !player.paralyzed && !player.rooted) { const rect = canvas.getBoundingClientRect(); player.x = e.clientX - rect.left; player.y = e.clientY - rect.top; } }
        
        const handleWin = function() {
            clearAllTimers();
            
            if (lastBossDefeated === 'smile') { gameState.smileWins++; }
            else if (lastBossDefeated === 'brother') { gameState.brotherWins++; }
            else if (lastBossDefeated === 'supremacy') { gameState.supremacyWins++; }
            else if (lastBossDefeated === 'final') { gameState.finalWins++; }
            else if (lastBossDefeated === 'frog') { currentStoryPoint = 'beforeColonBoss'; showScreen('xpGainScreen'); elements.xpText.textContent = "Seu XP subiu para 1"; timers.push(setTimeout(() => { showScreen('newSmileScreen'); elements.newSmileText.textContent = "isso que vc viu, e xp, Basicamente o xp e seu nivel de habilidade"; timers.push(setTimeout(() => { showScreen('newEndScreen'); elements.newEndMessage.textContent = ""; timers.push(setTimeout(() => { elements.newEndMessage.textContent = "- vc e mais chato do que eu pensava..."; timers.push(setTimeout(() => triggerBossFightIntro('colon'), 3000)); }, 8000)); }, 4000)); }, 3000)); return; }
            else if (lastBossDefeated === 'colon') { 
                showNotification("Você derrotou ●_●... mas ainda não acabou.");
                timers.push(setTimeout(() => triggerBossFightIntro('final'), 3000));
                return; 
            }
            
            saveGame();
            
            if (lastBossDefeated === 'supremacy' || lastBossDefeated === 'final') {
                initializeGame(true);
            } else if (lastBossDefeated === 'system') {
                showScreen('hackerEndingScreen');
            }
            else {
                showScreen('victoryScreen');
            }
        }
        let winGame = handleWin;

        function showCredits() { initializeGame(true); }
        function loseGame() {
            if(isGameOver) return;
            isGameOver = true;

            clearAllTimers();
            if (lastBossDefeated === 'final') {
                gameState.finalWins++;
                saveGame();
                startSubsoloPath();
                return;
            }
            let msg = "";
            if (lastBossDefeated === 'supremacy') msg = "relaxe... isso e so um sonho, MAS VOCE NAO PODE ACORDAR HAHAHAHAHAHAHAHAHHAHAHAHAHAHAHAHAHA";
            if (lastBossDefeated === 'colon') msg = "Vc e muito fraco uhum...";
            elements.gameOverMessage.textContent = msg;
            showScreen('gameOverScreen');
        }

        // --- Event Listeners ---
        buttons.white.addEventListener('click', () => showScreen('windowsScreen'));
        elements.gameIcon.addEventListener('click', () => { currentQuiz1Index = 0; loadQuiz1Question(); showScreen('quizScreen'); });
        buttons.toEnd.addEventListener('click', () => { showScreen('endScreen'); elements.endMessage.textContent = ""; clearAllTimers(); timers.push(setTimeout(() => { elements.endMessage.textContent = "Porque vc ainda esta aqui? Saia logo!"; timers.push(setTimeout(() => { showScreen('angryScreen'); timers.push(setTimeout(() => { showScreen('jumpscareScreen'); timers.push(setTimeout(() => { showScreen('connectionLostScreen'); timers.push(setTimeout(() => { showScreen('handScreen'); }, 7000)); }, 2000)); }, 3000)); }, 7000)); }, 24000)); });
        elements.hand.addEventListener('click', () => { showScreen('secondQuizScreen'); playAudio(audio.quiz); currentQuiz2Index = 0; loadQuiz2Question(); });
        buttons.fight.addEventListener('click', handlePlayerAttack);
        buttons.heal.addEventListener('click', handlePlayerHeal);
        buttons.transform.addEventListener('click', handlePlayerTransform);
        buttons.callAlly.addEventListener('click', handleCallAlly);
        elements.crown.addEventListener('click', showCredits);
        buttons.retry.addEventListener('click', () => triggerBossFightIntro(lastBossDefeated));
        buttons.dialogue.addEventListener('click', () => { buttons.dialogue.classList.add('hidden'); elements.bwIntroText.textContent = "Voce: Se voce e tao bom assim, porque vc perdeu?"; timers.push(setTimeout(() => triggerBossFightIntro('supremacy'), 4000)); });
        
        buttons.newStart.addEventListener('click', () => {
             if (gameState.arc2Unlocked) {
                startNewJourneyPath();
             } else {
                showScreen('newSmileScreen');
                elements.newSmileText.textContent = "Oi novato! bem vindo ao novo mundo! clique no botao abaixo para continuar";
                buttons.newContinue.classList.remove('hidden');
                buttons.newContinue.onclick = () => {
                    showScreen('newSmileScreen');
                    elements.newSmileFace.textContent = "●_●";
                    elements.newSmileText.textContent = "Vamos logo!!! clique na porcaria do botão abaixo";
                    buttons.newContinue.onclick = () => { showScreen('foodQuizScreen'); loadFoodQuizQuestion(); };
                };
             }
        });

        buttons.save.addEventListener('click', () => saveGame());
        buttons.confirmLoad.addEventListener('click', () => { showScreen('startScreen'); loadGame(); });
        buttons.denyLoad.addEventListener('click', () => { clearAllProgress(); initializeGame(true); });
        
        elements.soulHeart.addEventListener('click', startSoulTraining);
        
        buttons.help.addEventListener('click', function handler() {
            buttons.help.classList.add('hidden');
            elements.subsoloText.textContent = "Vc pediu ajuda";
            timers.push(setTimeout(() => {
                elements.subsoloText.textContent = "algo aconteceu mas vc não sentiu...";
                timers.push(setTimeout(() => {
                    showScreen('soulScreen');
                    elements.soulText.textContent = "Clique no seu coração para treinar.";
                }, 3000));
            }, 3000));
        });
        
        function openPasswordModal(mode) {
            currentPasswordCheck = mode;
            let title = '';
            let buttonColor = '';
            if (mode === 'samuka') {
                if (samukaModeActive) { openSecretModePanel('samuka'); return; }
                title = "Senha do Samuka:";
                buttonColor = 'bg-yellow-600';
            } else if (mode === 'dolly') {
                if (dollyModeActive) { openSecretModePanel('dolly'); return; }
                title = "Senha do Dolly:";
                buttonColor = 'bg-pink-600';
            } else if (mode === 'luan') {
                if (luanModeActive) { openSecretModePanel('luan'); return; }
                title = "Senha do Luan (Dono):";
                buttonColor = 'bg-red-800';
            }
            elements.passwordModalTitle.textContent = title;
            buttons.passwordSubmit.className = `ml-2 px-4 py-2 rounded-lg ${buttonColor}`;
            elements.passwordInput.value = '';
            showScreen('passwordModal');
        }

        function openSecretModePanel(mode) {
             if (mode === 'samuka') {
                elements.secretModeTitle.textContent = "Modo Samuka Ativado";
                elements.secretModePanel.className = "bg-gray-900 p-8 rounded-lg text-white shadow-2xl border-4 border-yellow-500 max-w-4xl w-full";
                elements.secretModeExclusive.classList.add('hidden');
            } else if (mode === 'dolly') {
                elements.secretModeTitle.textContent = "Modo Dolly Ativado";
                elements.secretModePanel.className = "bg-gray-900 p-8 rounded-lg text-white shadow-2xl border-4 border-pink-500 max-w-4xl w-full";
                elements.secretModeExclusive.innerHTML = "Comandos Exclusivos Dolly:<br>'win battle', 'skip quiz', 'unlock all'";
                elements.secretModeExclusive.classList.remove('hidden');
            } else if (mode === 'luan') {
                elements.secretModeTitle.textContent = "Modo Luan (Dono)";
                elements.secretModePanel.className = "bg-gray-900 p-8 rounded-lg text-white shadow-2xl border-4 border-red-700 max-w-4xl w-full";
                elements.secretModeExclusive.innerHTML = "Todos os comandos estão disponíveis.";
                elements.secretModeExclusive.classList.remove('hidden');
            }
            showScreen('secretModeScreen');
        }

        buttons.luan.addEventListener('click', () => openPasswordModal('luan'));
        buttons.samuka.addEventListener('click', () => openPasswordModal('samuka'));
        buttons.dolly.addEventListener('click', () => openPasswordModal('dolly'));

        buttons.passwordSubmit.addEventListener('click', () => {
            const password = elements.passwordInput.value;
            let correct = false;
            let mode = currentPasswordCheck;
            if (mode === 'samuka' && password === 'Samuka Deju22') {
                samukaModeActive = true;
                correct = true;
            } else if (mode === 'dolly' && password === 'Previews Dolly92') {
                dollyModeActive = true;
                correct = true;
            } else if (mode === 'luan' && password === 'LUAN CREATOR 999999') {
                luanModeActive = true;
                samukaModeActive = true; 
                dollyModeActive = true;
                correct = true;
            }

            if (correct) {
                screens.passwordModal.classList.add('hidden');
                openSecretModePanel(mode);
                elements.passwordInput.value = '';
            } else {
                showNotification('Senha incorreta!');
            }
        });
        
        buttons.secretCommandSubmit.addEventListener('click', () => {
            const command = elements.secretCommandInput.value.trim();
            
            if (command === 'set attaque +9999999') {
                secretAttackBoost = 9999999;
                showNotification('Comando de ataque ativado!');
            } else if (command === 'set live +9999999') {
                secretHealthBoost = 9999999;
                showNotification('Comando de vida ativado!');
            } else if ((dollyModeActive || luanModeActive) && command === 'win battle') {
                if (!screens.bossFightScreen.classList.contains('hidden')) {
                    winGame();
                    showNotification('Batalha vencida!');
                } else {
                    showNotification('Comando só pode ser usado em batalha.');
                }
            } else if ((dollyModeActive || luanModeActive) && command === 'skip quiz') {
                if (!screens.quizScreen.classList.contains('hidden')) { handleQuiz1Answer(quiz1Data[currentQuiz1Index].correct); handleQuiz1Answer(quiz1Data[currentQuiz1Index].correct); handleQuiz1Answer(quiz1Data[currentQuiz1Index].correct); }
                else if (!screens.secondQuizScreen.classList.contains('hidden')) { handleQuiz2Answer(quiz2Data[currentQuiz2Index].correct); handleQuiz2Answer(quiz2Data[currentQuiz2Index].correct); handleQuiz2Answer(quiz2Data[currentQuiz2Index].correct); }
                else if (!screens.chemQuizScreen.classList.contains('hidden')) { handleChemQuizAnswer(chemQuizData[currentChemQuizIndex].correct); handleChemQuizAnswer(chemQuizData[currentChemQuizIndex].correct); handleChemQuizAnswer(chemQuizData[currentChemQuizIndex].correct); handleChemQuizAnswer(chemQuizData[currentChemQuizIndex].correct); }
                else if (!screens.selfQuizScreen.classList.contains('hidden')) { handleSelfQuizAnswer(selfQuizData[currentSelfQuizIndex].correct); handleSelfQuizAnswer(selfQuizData[currentSelfQuizIndex].correct); handleSelfQuizAnswer(selfQuizData[currentSelfQuizIndex].correct); }
                else { showNotification('Nenhum quiz ativo.'); return; }
                showNotification('Quiz completo!');
            } else if ((dollyModeActive || luanModeActive) && command === 'unlock all') {
                gameState.smileWins = 3;
                gameState.brotherWins = 3;
                gameState.supremacyWins = 1;
                gameState.selfQuizCompleted = true;
                saveGame();
                showNotification('Todo o progresso foi desbloqueado!');
                initializeGame(true);
            }
            else {
                showNotification('Comando desconhecido ou não permitido.');
            }
            elements.secretCommandInput.value = '';
        });

        document.querySelectorAll('.teleport-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const boss = e.target.dataset.boss;
                screens.secretModeScreen.classList.add('hidden');
                triggerBossFightIntro(boss);
            });
        });
        buttons.secretContinue.addEventListener('click', () => screens.secretModeScreen.classList.add('hidden'));
        
        document.addEventListener('keydown', (e) => {
            hackerSequence.push(e.key);
            hackerSequence = hackerSequence.slice(-konamiCode.length);
            if (JSON.stringify(hackerSequence) === JSON.stringify(konamiCode)) {
                const hackingScreen = document.getElementById('hackingScreen'); // This element doesn't exist, might need to create it.
                if(hackingScreen) {
                    showScreen('hackingScreen');
                    let text = '';
                    const interval = setInterval(() => {
                        text += Math.random().toString(36).substring(2, 15);
                        hackingScreen.textContent = text;
                        if (text.length > 5000) {
                            clearInterval(interval);
                            triggerBossFightIntro('system');
                        }
                    }, 50);
                } else {
                    triggerBossFightIntro('system');
                }
            }
        });

        // --- Início ---
        window.onresize = setupCanvas;
        
        initializeGame();
    });
    </script>
</body>
</html>
